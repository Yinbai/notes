# 搞懂执行上下文和作用域

词法环境（Lexical environment）是 Javascript 引擎内部用来跟踪标识符与特定变量之间的映射关系。

词法环境是 Javascript 作用域的内部实现机制，通常称为作用域（scopes）。

## 通过执行上下文来跟踪代码



## 使用词法环境跟踪变量的作用域

- **代码嵌套**

  词法环境主要基于代码嵌套，通过代码嵌套可以实现代码结构包含另一种代码结构。

  ```javascript
  <script>
  	var f = "Hope";
  	function foo() {
  		var action = "eating";
  		function report() {
  			var count = 3;
  			for (var i = 0; i < count; i++) {
  				console.log(f + " " + action + " " + i);
  			}
  		}
      report();
  	}
  	foo();
  </script>
  ```

  在作用域范围内，每次执行代码时，代码结构都获得与之关联的词法环境，内部代码结构可以访问外部代码结构中定义的变量。Javascript 引擎是如何跟踪这些变量的呢，如何判断可访问性呢？这就是词法环境的作用。

- **代码嵌套与词法环境**

  除了跟踪局部变量、函数声明、函数的参数和词法环境外，还有必要跟踪外部（父级）词法环境。如果在当前环境中无法找到某一标识符，就会对外部环境进行查找。一旦查找到匹配的变量，或是在全局环境中仍然无法查找到对应的标识符而返回错误，就会停止查找。



## 理解 Javascript 的变量类型

在 Javascript 中，我们可以通过 3 个关键字定义变量：var、let 和 const。这 3 个关键字有两点不同：可变性、与词法环境的关系。

- **变量可变性**

  如果通过变量的可变性来进行分类，可以将 var 和 let 放在一组，const 放在一组。通过 var 或 let 声明的变量可以任意改变值，通过 const 定义的变量都不可变。

- **定义变量的关键字与词法环境的关系**

  如果通过与词法环境的关系来进行分类，可以将 var 分为一组，let 和 const 分为一组。

  - 关键字 var

    此时变量是在距离最近的函数内部或是全局词法环境中定义的（忽略块级作用域）。

  - 关键字 let 和 const

    此时变量是在距离最近的词法环境中定义的（可以是块级作用域、循环内、函数内或全局环境内）。

- **在词法环境中注册标识符**

  Javascript 代码的执行事实上是分两个阶段进行。

  第一阶段：

  没有执行代码，但是 Javascript 引擎会访问并注册在当前词法环境中所声明的变量和函数。

  第二阶段：

  具体如何执行取决于变量的类型（var、let、const 和函数声明）以及环境类型（全局环境、函数环境或块作用域）。

  具体处理过程：

  1. 如果是创建一个函数环境，那么创建形参及函数参数的默认值，如果是非函数环境，跳过此步骤
  2. 如果是创建全局或函数环境，就扫描当前代码进行函数声明（不会扫描其他函数的函数体），但是不会扫描函数表达式和箭头函数。对于所找到的函数声明，将创建函数，并绑定到当前环境与函数名相同的标识符上。若该标识符已经存在，那么该标识符的值将被重写。如果是块级作用域，将跳过次步骤
  3. 在函数或全局环境中，扫描当前代码进行变量声明，找到所有当前函数以及其他函数之外通过 var 声明的变量，并找到所有在其他函数或代码块之外通过 let 或 const 定义的变量。在块级环境中，仅查找当前块中通过 let 或 const 定义的变量。对于所查找到的变量，若该标识符不存在，进行注册并将其初始化为 undefined。若该标识符已经存在，将保留其值





## 问题

1. 词法环境是函数被调用时创建还是函数被创建时创建？